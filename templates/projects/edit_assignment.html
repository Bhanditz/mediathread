{% extends "base.html" %}
{% load user_annotations tagging_tags smartif user_projects threadedcomments_tags coursetags %}

{% block title %}
{% if is_space_owner %}
    My Compositions > 
    {% if project.title %}{{project.title}}{% else %}New Composition{% endif %}
{% else %}
    Class Analysis > 
    {{space_owner.username}}'s Compositions > 
    {% if project.title %}{{project.title}}{% else %}New Composition{% endif %}
{% endif %}
{% endblock %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="/site_media/css/project.css" />
    <script type="text/javascript" src="/jsi18n"></script>
    {{ projectform.media }}

    <!--All the annotation css -->
    {% include "djangosherd/annotator_resources_css.html" %}
{% endblock %}

{% block js %}
    <!--All the annotation javascript/css -->
    {% include "djangosherd/annotator_resources.html" %}

    <script type="text/javascript" src="/site_media/js/project/project.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/mustache/mustache.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/assetmgr/asset.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/hs.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/jquery.colorBlend.js"></script>
    <script type="text/javascript" src="/site_media/js/ajaxDelete.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/panel.js?version={{settings.REVISION}}"></script>
    
    <script type="text/javascript">
        function resizeEditProjectPage() {
            var visible = getVisibleContentHeight();

            // Resize the outer table. This takes care of the panhandles & panhandle stripes
            jQuery("#sliding-content-container").css('height', visible + "px");

            // Resize inner elements
            // tinyMCE project editing window
            jQuery('#project-content_tbl').css('height', (visible - 100) + "px");

            // scrolling media window
            jQuery('div.scroll').css('height', (visible - 133) + "px");

            // Reset width to 100% via javascript. TinyMCE doesn't resize properly 
            // if this isn't completed AFTER instantiation
            jQuery('#project-content_tbl').css('width', "100%");
        }
      
        jQuery(document).ready(function () {
            ProjectView.initEditing({
                'open_from_hash':false, 
                'project_json':'./json', 
                'project_id': '{{project.id}}',
                'space_owner': '{% ifnotequal role_in_course "non-member" %}{{space_owner.username}}{% endifnotequal %}',
                'view_callback': resizeEditProjectPage,
                'enable_project_selection': false
            }); 

            PanelManager.init();

            jQuery(window).resize(function () {  
                resizeEditProjectPage();
            });
        });
  </script>
{% endblock %}

{% block content %}
    {{ block.super }}
    
    <table id="sliding-content-container">
        <tr id="table-content">
    
            <!--BEGIN ASSIGNMENT PANEL-->   
            <td id="assignment-panhandle-left" class="panhandle-left-container">
                <div class="panhandle-left assignment"></div>
            </td>
            
            <td id="assignment-panhandle-stripe" class="panhandle-stripe assignment">
                <div id="assignment-panhandle-label" class="label">Assignment</div>
            </td>
    
            <td id="assignment-panel" class="panel-container closed">
                <div class="panel">
                    <table id="assignment-subcontainer" class="panel-subcontainer">
                        {% with project.assignment as assignment %}
                        <tr>
                            <td colspan="4" id="assignment-meta">        
                                <div class="assignment-project">
                                <h1>{{assignment.title}}</h1>
                                <h5>by <span id="participants_chosen">{% public_name for project.assignment.attribution_list %}</span></h5>
                                </div>    
                            </td>
                        </tr>
                        <tr class="fluid">
                            <td id="assignment-body">
                                <div class="essay-space">  
                                    {{assignment.body|safe}}
                                </div>
                            </td>
                            <td id="assignment-media" class="panel-container closed">
                                <div id="assignment-media-container"></div>
                            </td>
                            <td id="assignment-media-panhandle-stripe" class="panhandle-stripe media">
                                <div id="assignment-media-panhandle-label" class="label">View Selection</div>
                            </td>
                            <td id="assignment-media-pantab" class="pantab-container">
                                <div class="pantab assignment media closed"></div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" id="assignment-response-data"></td>
                        </tr>
                        {% endwith %}
                    </table>
                </div>
            </td>
            
            <td id="assignment-pantab" class="pantab-container">
                <div class="pantab assignment closed"></div>
            </td>
            
            <!--END ASSIGNMENT PANEL-->
              
            <!--BEGIN COMPOSITION PANEL-->
        
            <td id="composition-panhandle-left" class="panhandle-left-container">
                <div class="panhandle-left composition"></div>
            </td>
            
            <td id="composition-panhandle-stripe" class="panhandle-stripe composition">
                <div id="composition-panhandle-label" class="label">Composition</div>
            </td>
            
            <td id="composition-panel" class="panel-container fluid open composition">
                <div class="panel">
                    <form id="editproject" name="editproject" method="POST" action=".">
                        {% with project.assignment as assignment %}
                      
                        <table id="composition-subcontainer" class="panel-subcontainer">
                            <tr>
                                <td colspan="4">        
                                    <div id="last-version-saved">
                                    <span id="last-version-prefix"></span><a id="last-version-link" href="{%url project_version_preview project.id project.get_latest_version %}" target="mediathread_lastproject{{project.id}}">Revision {{project.get_latest_version}}</a>
                                    <span id="last-version-public">
                                    {% if project.public_url %}
                                    (<a href="{{project.public_url}}">public url</a>)
                                    {% endif %}
                                    </span>
                                    </div>
                                    <div class="project-form-title"><h1>Title: {{projectform.title}}</h1></div>
                                    
                                    <h5>
                                        by <span id="participants_chosen">{%for part in project.participants.all %}{%if not forloop.first%}, {%endif%}{%public_name for part %}{%endfor%}</span>
                                        <span id="project_participants">
                                            <div id="participant_update" style="display:none">Save the Composition to save the author list.</div>
                                            <input class="project participants_toggle" type="submit" name="participants" value="+/-"/>
                                            <div id="participant_list" class="hs-init-hide hs-hide" style="height: 150px; margin-bottom: 5px;"> 
                                                <div>{{projectform.participants}}</div> 
                                            </div>
                                        </span><!-- end id="project_participants" -->
                                    </h5>
                                </td>
                            </tr>
                                
                            <tr class="fluid">
                                <td id="composition-body">
                                    <div id="project-form-buttons"> 
                                        <input class="project previewbutton" type="submit" name="submit" value="Preview" onclick="this.form.target='mediathreadpreview';this.form.action='?preview='+(window.preview_num = ++window.preview_num || 1);"/>
                                 
                                        
                                        <input class="project project-savebutton" type="submit" name="submit" value="Save" onclick="this.form.target='_self';"/>
                                        <span class="project-dropdown">
                                                {{projectform.publish.label_tag}}    
                                                {{projectform.publish}}
                                        </span>
                                        
                                    </div>
                                    <div>
                                        <script type="text/javascript">
                                            var tinyMCEPreInit = {query:'',suffix:'',base:'/site_media/js/sherdjs/lib/tiny_mce3/jscripts/tiny_mce'};
                                        </script>
                                        <script type="text/javascript" src="/site_media/js/sherdjs/lib/tiny_mce3_min.js"></script>
                                        <script type="text/javascript" src="/site_media/js/tiny_mce_init3.js"></script>
                                        <textarea id="project-content" tabindex="0" name="body" class="mceEditor" mce_editable="true" style="height: 100%">{{project.body|safe}}</textarea>
                                    </div>
                    


                                </td>
                                <td id="collection-container" class="panel-container open">
                                    <div id="collection-materials">
                                        <h2>
                                            <div class="button-form inline">
                                                <a class="columnbutton media browse-button" href="/explore">Source Media</a>
                                            </div>
                                            Collections
                                        </h2>
                                        <div id="collection_table"></div>
                                    </div>
                                </td>
                                <td id="composition-collection-panhandle-stripe" class="panhandle-stripe collection">
                                    <div id="composition-collection-panhandle-label" class="label">Add Selection</div>
                                </td>
                                <td id="composition-collection-pantab" class="pantab-container">
                                    <div class="pantab collection open"></div>
                                </td>
                                <td class="filler"></td>
                            </tr>
                        </table>
                        {% endwith %}
                    </form>   
                </div>
            </td>
            
            <td id="composition-pantab" class="pantab-container">
                <div class="pantab composition open"></div>
            </td>
            <!--END COMPOSITION PANEL-->
        
            <td class="filler"></td>
        </tr>
    </table>
    
    

{% endblock %}
