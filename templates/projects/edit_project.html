{% extends "base.html" %}
{% load user_annotations tagging_tags smartif user_projects threadedcomments_tags coursetags %}

{% block title %}
{% if is_space_owner %}
    My Compositions > 
    {% if project.title %}{{project.title}}{% else %}New Composition{% endif %}
{% else %}
    Class Analysis > 
    {{space_owner.username}}'s Compositions > 
    {% if project.title %}{{project.title}}{% else %}New Composition{% endif %}
{% endif %}
{% endblock %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="/site_media/css/project.css" />
    <script type="text/javascript" src="/jsi18n"></script>
    {{ projectform.media }}

    <!--All the annotation css -->
    {% include "djangosherd/annotator_resources_css.html" %}
{% endblock %}

{% block js %}
    <!--All the annotation javascript/css -->
    {% include "djangosherd/annotator_resources.html" %}

    <script type="text/javascript" src="/site_media/js/project/project.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/mustache/mustache.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/assetmgr/asset.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/jquery.colorBlend.js"></script>
    <script type="text/javascript" src="/site_media/js/ajaxDelete.js?version={{settings.REVISION}}"></script>
    <script type="text/javascript" src="/site_media/js/panel.js?version={{settings.REVISION}}"></script>
    
    <script type="text/javascript">
        function resizeEditProjectPage() {
            var visible = getVisibleContentHeight();

            // Resize the outer table. This takes care of the panhandles & panhandle stripes
            jQuery("#sliding-content-container").css('height', visible + "px");

            // tinyMCE project editing window
            jQuery('#project-content_tbl').css('height', (visible - 100) + "px");
            // Reset width to 100% via javascript. TinyMCE doesn't resize properly 
            // if this isn't completed AFTER instantiation
            jQuery('#project-content_tbl').css('width', "100%");
            
            // scrolling media (collections) window
            jQuery('div.scroll').css('height', (visible - 133) + "px");
        }
      
        jQuery(document).ready(function () {
            ProjectView.initEditing({
                'open_from_hash':false, 
                'project_json':'./json', 
                'project_id': '{{project.id}}',
                'space_owner': '{% ifnotequal role_in_course "non-member" %}{{space_owner.username}}{% endifnotequal %}',
                'view_callback': resizeEditProjectPage,
                'enable_project_selection': false,
                'presentation': 'small',
                'targets': [ { 'parent': 'assignment-essay-space', 'default_target': 'assignment-videoclipbox' } ]    
            }); 

            PanelManager.init();

            jQuery(window).resize(function () {  
                resizeEditProjectPage();
            });
        });
  </script>
{% endblock %}

{% block content %}
    {{ block.super }}
    
    <table id="sliding-content-container">
        <tr>
            {% if project.assignment %}
                <!--BEGIN ASSIGNMENT PANEL-->   
                <td class="panhandle-left-container">
                    <div class="panhandle-left assignment"></div>
                </td>
                
                <td class="panhandle-stripe assignment">
                    <div class="label">View Assignment</div>
                </td>
        
                <td class="panel-container closed assignment">
                    <div class="panel">
                        <table class="panel-subcontainer">
                            {% with project.assignment as assignment %}
                            <tr>
                                <td colspan="4">        
                                    <div class="assignment-project">
                                    <h1>{{assignment.title}}</h1>
                                    <h5>by <span id="participants_chosen">{% public_name for project.assignment.attribution_list %}</span></h5>
                                    </div>    
                                </td>
                            </tr>
                            <tr class="fluid">
                                <td class="panel-content fixed">
                                    <div id="assignment-essay-space" class="essay-space">  
                                        {{assignment.body|safe}}
                                    </div>
                                </td>
                                
                                <td class="panel-container closed media">
                                    <div class="asset-view-published">
                                        <div id="assignment-videoclipbox" style="display: none">
                                            {% if project|is_assignment:request %}<div class="create-selection" style="float: right"></div>{% endif %}
                                            <div class="annotation-title publishedCitation" style="margin-left: 8px; margin-top: 5px;"></div>
                                            <div class="asset-title" style="margin-left: 5px; margin-bottom: 8px; min-height: 20px;"></div>
                                            <div class="asset-object" style="border: none; background-color: #ededed;"><!-- width changes here too if video size changes -->
                                                <div class="asset-display"></div>
                                                <div class="clipstrip-display"></div>    
                                            </div>
                                            
                                        </div>
                                    </div>
                                </td>
                                <td class="panhandle-stripe media">
                                    <div class="label">View Selection</div>
                                </td>
                                <td class="pantab-container">
                                    <div class="pantab media closed"></div>
                                </td>
                            </tr>
                            {% endwith %}
                        </table>
                    </div>
                </td>
                
                <td class="pantab-container">
                    <div class="pantab assignment closed"></div>
                </td>
                
                <!--END ASSIGNMENT PANEL-->
            {% endif %}
                  
            <!--BEGIN COMPOSITION PANEL-->
            {% with project|project_type:request as project_type %}
            
            <td class="panhandle-left-container">
                <div class="panhandle-left {{project_type}}"></div>
            </td>
            
            <td class="panhandle-stripe {{project_type}}">
                <div class="label">Edit {{project_type}}</div>
            </td>
            
            <td class="panel-container open {{project_type}}">
                <div class="panel">
                    <form name="editproject" method="POST" action=".">
                        <table class="panel-subcontainer {{project_type}}">
                            <tr>
                                <td colspan="4">        
                                    <div id="last-version-saved">
                                    <span id="last-version-prefix"></span><a id="last-version-link" href="{%url project_version_preview project.id project.get_latest_version %}" target="mediathread_lastproject{{project.id}}">Revision {{project.get_latest_version}}</a>
                                    <span id="last-version-public">
                                    {% if project.public_url %}
                                    (<a href="{{project.public_url}}">public url</a>)
                                    {% endif %}
                                    </span>
                                    </div>
                                    <div class="project-form-title"><h1>Title: {{projectform.title}}</h1></div>
                                    
                                    <h5>
                                        by <span id="participants_chosen">{%for part in project.participants.all %}{%if not forloop.first%}, {%endif%}{%public_name for part %}{%endfor%}</span>
                                        <span id="project_participants">
                                            <input class="project participants_toggle" type="submit" name="participants_toggle" value="+/-"/>
                                            <span id="participant_update" style="display:none">Save the project to save the author list.</span>
                                            <div id="participant_list" style="display: none"> 
                                                <div>{{projectform.participants}}</div> 
                                            </div>
                                        </span><!-- end id="project_participants" -->
                                    </h5>
                                </td>
                            </tr>
                                
                            <tr class="fluid">
                                <td class="panel-content fluid">
                                    <div id="project-form-buttons"> 
                                        <input class="project previewbutton" type="submit" name="submit" value="Preview" onclick="this.form.target='mediathreadpreview';this.form.action='?preview='+(window.preview_num = ++window.preview_num || 1);"/>
                                 
                                        
                                        <input class="project project-savebutton" type="submit" name="submit" value="Save" onclick="this.form.target='_self';"/>
                                        <span class="project-dropdown">
                                                {{projectform.publish.label_tag}}    
                                                {{projectform.publish}}
                                        </span>
                                        
                                    </div>
                                    <div>
                                        <script type="text/javascript">
                                            var tinyMCEPreInit = {query:'',suffix:'',base:'/site_media/js/sherdjs/lib/tiny_mce3/jscripts/tiny_mce'};
                                        </script>
                                        <script type="text/javascript" src="/site_media/js/sherdjs/lib/tiny_mce3_min.js"></script>
                                        <script type="text/javascript" src="/site_media/js/tiny_mce_init3.js"></script>
                                        <textarea id="project-content" tabindex="0" name="body" class="mceEditor" mce_editable="true" style="height: 100%">{{project.body|safe}}</textarea>
                                    </div>
                                </td>
                                <td class="panel-container collection open">
                                    <div id="collection-materials">
                                        <h2>
                                            <div class="button-form inline">
                                                <a class="columnbutton media browse-button" href="/explore">Source Media</a>
                                            </div>
                                            Collections
                                        </h2>
                                        <div id="collection_table"></div>
                                    </div>
                                </td>
                                <td class="panhandle-stripe collection">
                                    <div class="label">Add Selection</div>
                                </td>
                                <td class="pantab-container">
                                    <div class="pantab collection open"></div>
                                </td>
                                <td class="filler"></td>
                            </tr>
                        </table>
                    </form>   
                </div>
            </td>
            
            <td class="pantab-container">
                <div class="pantab {{project_type}} open"></div>
            </td>
            {% endwith %}
            <!--END COMPOSITION PANEL-->
        
            <td class="filler"></td>
        </tr>
    </table>
    
    

{% endblock %}
