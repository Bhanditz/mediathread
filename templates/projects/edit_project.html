{% extends "base.html" %}
{% load user_annotations tagging_tags smartif user_projects threadedcomments_tags coursetags revision %}

{% block title %}
{% if is_space_owner %}
    My Compositions > 
    {% if project.title %}{{project.title}}{% else %}New Composition{% endif %}
{% else %}
    Class Analysis > 
    {{space_owner.username}}'s Compositions > 
    {% if project.title %}{{project.title}}{% else %}New Composition{% endif %}
{% endif %}
{% endblock %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="/site_media/css/project.css?version={%revision%}" />
    <link rel="stylesheet" href="/site_media/js/sherdjs/lib/mcePlugin_citation/skins/minimalist/citation.css?version={%revision%}" />
    
    <script type="text/javascript" src="/jsi18n"></script>
    {{ projectform.media }}
    
    <!--All the annotation css -->
    {% include "djangosherd/annotator_resources_css.html" %}
{% endblock %}

{% block js %}
    <!--All the annotation javascript/css -->
    {% include "djangosherd/annotator_resources.html" %}

    <script type="text/javascript" src="/site_media/js/project/project.js?version={%revision%}"></script>
    <script type="text/javascript" src="/site_media/js/mustache/mustache.js?version={%revision%}"></script>
    <script type="text/javascript" src="/site_media/js/assetmgr/asset.js?version={%revision%}"></script>
    <script type="text/javascript" src="/site_media/js/jquery.colorBlend.js"></script>
    <script type="text/javascript" src="/site_media/js/ajaxDelete.js?version={%revision%}"></script>
    <script type="text/javascript" src="/site_media/js/panel.js?version={%revision%}"></script>
    

    
    
    <script type="text/javascript">
        function resizeEditProjectPage() {
            var visible = getVisibleContentHeight();

            // Resize the outer table. This takes care of the panhandles & panhandle stripes
            jQuery("#sliding-content-container").css('height', visible + "px");

            // tinyMCE project editing window
            jQuery('#project-content_tbl').css('height', (visible - 100) + "px");
            jQuery('#composition-essay-space').css('height', (visible - 112) + "px");
            // Reset width to 100% via javascript. TinyMCE doesn't resize properly 
            // if this isn't completed AFTER instantiation
            jQuery('#project-content_tbl').css('width', "100%");
            
            // scrolling media (collections) window
            jQuery('div.scroll').css('height', (visible - 133) + "px");
        }
      
        jQuery(document).ready(function () {
            jQuery("div#collection_table").ajaxStart(function(){
                jQuery(this).addClass("ajaxLoading");
            });
            
            jQuery("div#collection_table").ajaxStop(function(){
                jQuery(this).removeClass("ajaxLoading");
            });
            
            ProjectView.initEditing({
                'open_from_hash':false, 
                'project_json':'./json', 
                'project_id': '{{project.id}}',
                'space_owner': '{% ifnotequal role_in_course "non-member" %}{{space_owner.username}}{% endifnotequal %}',
                'view_callback': resizeEditProjectPage,
                'enable_project_selection': false,
                'presentation': 'medium',
                'targets': [ { 'parent': 'assignment-essay-space', 'default_target': 'assignment-videoclipbox' },
                             { 'parent': 'composition-essay-space', 'default_target': 'composition-videoclipbox' }
                           ]    
            }); 

            PanelManager.init({ 'container': 'sliding-content-container' });

            jQuery(window).resize(function () {  
                resizeEditProjectPage();
            });
        });
  </script>
{% endblock %}

{% block content %}
    {{ block.super }}
    
    <table id="sliding-content-container">
        <tr>
            {% if project.assignment %}
                <!--BEGIN ASSIGNMENT PANEL-->   
                <td class="panhandle-left-container">
                    <div class="panhandle-left assignment"></div>
                </td>
                
                <td class="panhandle-stripe assignment">
                    <div class="label">View Assignment</div>
                </td>
        
                <td class="panel-container closed assignment">
                    <div class="panel">
                        <table class="panel-subcontainer">
                            {% with project.assignment as assignment %}
                            <tr>
                                <td colspan="4" class="panel-subcontainer-toolbar-column">
                                    <div class="panel-subcontainer-title assignment-project">
                                        <h1>{{assignment.title}}</h1>
                                    </div>
                                    <div class="panel-subcontainer-toolbar">
                                        {%comment%}
                                        <input id="save-button" class="project project-savebutton" type="submit" value="Save &amp; Publish" />
                                        
                                        <input id="preview-button" class="project project-previewbutton" type="submit" value="Preview" onclick="return ProjectView.preview()" />
                                        
                                        <input id="revision-button" class="project project-revisionbutton" type="submit" name="submit" value="Revisions" disabled="disabled" />
                                        
                                        <div class="project-visibility" style="vertical-align: middle";>
                                                <b>Visibility</b>:<br />
                                                <span id="project-visibility">{{project.visibility}}</span>
                                                <a id="last-version-public" style="display: {% if project.public_url %}inline{%else%}none{% endif %}" href="{% if project.public_url %}{{project.public_url}}{% endif %}">(permalink)</a>
                                        </div>
                                        {%endcomment%}
                                    </div>   
                                </td>
                            </tr>
                            
                            <tr>                                      
                                <td colspan="4" style="padding-top: 5px">
                                    <h5 style="margin-top: 0px;">by <span>{% public_name for project.assignment.attribution_list %}</span></h5>
                                </td>
                            </tr>
                            
                            <tr>
                                <td class="panel-content fluid assignment">
                                    <div id="assignment-essay-space" class="essay-space">  
                                        {{assignment.body|safe}}
                                    </div>
                                </td>
                                
                                <td class="panel-container media medium closed">
                                    <div class="asset-view-published medium">
                                        <div id="assignment-videoclipbox" style="display: none">
                                            <div class="create-selection" style="float: right"></div>
                                            <div class="annotation-title publishedCitation" style="margin-left: 8px; margin-top: 5px;"></div>
                                            <div class="asset-title" style="margin-left: 5px; margin-bottom: 8px; min-height: 20px;"></div>
                                            <div class="asset-object" style="border: none; background-color: #ededed;"><!-- width changes here too if video size changes -->
                                                <div class="asset-display"></div>
                                                <div class="clipstrip-display"></div>    
                                            </div>
                                            
                                        </div>
                                    </div>
                                </td>
                                <td class="panhandle-stripe media">
                                    <div class="label">View Selection</div>
                                </td>
                                <td class="pantab-container">
                                    <div class="pantab media closed"></div>
                                </td>
                            </tr>
                            {% endwith %}
                        </table>
                    </div>
                </td>
                
                <td class="pantab-container">
                    <div class="pantab assignment closed"></div>
                </td>
                
                <!--END ASSIGNMENT PANEL-->
            {% endif %}
                  
            <!--BEGIN COMPOSITION PANEL-->
            {% with project|project_type:request as project_type %}
            
            <td class="panhandle-left-container">
                <div class="panhandle-left {{project_type}}"></div>
            </td>
            
            <td class="panhandle-stripe {{project_type}}">
                <div class="label">Edit {{project_type}}</div>
            </td>
            
            <td class="panel-container {{project_type}} open">
                <div class="panel">
                    <form name="editproject" method="POST" action=".">
                        <table class="panel-subcontainer {{project_type}}">
                            <tr>
                                <td colspan="5" class="panel-subcontainer-toolbar-column">
                                    <div class="panel-subcontainer-title">
                                        {{projectform.title}}
                                    </div>
                                    <div class="panel-subcontainer-toolbar">
                                        <input id="save-button" class="project project-savebutton" type="submit" value="Save &amp; Publish" />
                                        
                                        <input id="preview-button" class="project project-previewbutton" type="submit" value="Preview" onclick="return ProjectView.preview()" />
                                        
                                        <input id="revision-button" class="project project-revisionbutton" type="submit" name="submit" value="Revisions" disabled="disabled" />
                                        
                                        <div class="project-visibility" style="vertical-align: middle";>
                                                <b>Visibility</b>:<br />
                                                <span id="project-visibility">{{project.visibility}}</span>
                                                <a id="last-version-public" style="display: {% if project.public_url %}inline{%else%}none{% endif %}" href="{% if project.public_url %}{{project.public_url}}{% endif %}">(permalink)</a>
                                        </div>
                                    </div>   
                                </td>
                            </tr>
                            <tr>                                      
                                <td colspan="5" style="padding-top: 5px">
                                    <input id="participants_toggle" class="project participants_toggle" type="submit" value="+/- Author" style="float: left"/>
                                    <h5 style="margin-top: 0px">by <span id="participants_chosen">{%for part in project.participants.all %}{%if not forloop.first%}, {%endif%}{%public_name for part %}{%endfor%}</span>
                                    </h5>
                                </td>
                            </tr>
                            
                                
                            <tr class="fluid">
                                <td class="panel-content fluid composition">
                                    <div id="composition-text">
                                        <script type="text/javascript">
                                            var tinyMCEPreInit = {query:'',suffix:'',base:'/site_media/js/sherdjs/lib/tiny_mce3/jscripts/tiny_mce'};
                                        </script>
                                        <script type="text/javascript" src="/site_media/js/sherdjs/lib/tiny_mce3_min.js"></script>
                                        <script type="text/javascript" src="/site_media/js/tiny_mce_init3.js"></script>
                                        <textarea id="project-content" tabindex="0" name="body" class="mceEditor" mce_editable="true" style="height: 100%">{{project.body|safe}}</textarea>
                                        <div id="composition-essay-space" class="essay-space" style="display: none;">  
                                            {{project.body|safe}}
                                        </div>
                                    </div>
                                </td>
                                <td id="composition-materials" class="panel-container collection medium open">
                                    <div id="collection-materials">
                                        <h2>
                                            <div class="button-form inline">
                                                <a class="columnbutton media browse-button" href="/explore">Source Media</a>
                                            </div>
                                            Collections
                                        </h2>
                                        <div id="collection_table"></div>
                                    </div>
                                    <div id="composition-asset-view-published" class="asset-view-published medium" style="display: none">
                                        <div id="composition-videoclipbox" class="videoclipbox" style="display: none;">
                                            {% if project|is_assignment:request %}<div class="create-selection" style="float: right"></div>{% endif %}
                                            <div class="annotation-title publishedCitation" style="margin-left: 8px; margin-top: 5px;"></div>
                                            <div class="asset-title" style="margin-left: 5px; margin-bottom: 8px; min-height: 20px;"></div>
                                            <div class="asset-object" style="border: none; background-color: #ededed;"><!-- width changes here too if video size changes -->
                                                <div class="asset-display"></div>
                                                <div class="clipstrip-display"></div>    
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td id="composition-materials-panhandle" class="panhandle-stripe collection">
                                    <div id="composition-materials-panhandle-label" class="label">Add Selection</div>
                                </td>
                                <td class="pantab-container">
                                    <div id="composition-materials-pantab" class="pantab collection open"></div>
                                </td>
                            </tr>
                        </table>
                    </form>   
                </div>
            </td>
            
            <td class="pantab-container">
                <div class="pantab {{project_type}} open"></div>
            </td>
            {% endwith %}
            <!--END COMPOSITION PANEL-->
        
            <td class="filler"></td>
        </tr>
    </table>
    
    <!--  Dialogs -->
    <div id="save-publish-status" style="display: none" title="Save Changes">
        <form name="editvisibility">
            <div>{{projectform.publish.label_tag}}</div>    
            <div>{{projectform.publish}}</div>
        </form>
    </div>  
    
    <div id="participant_list" style="display: none" title="Select Author(s)">
        <form name="editparticipants"> 
            <div>{{projectform.participants}}</div>
        </form> 
    </div>
    

{% endblock %}
